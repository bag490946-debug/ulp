{% extends "base.html" %}
{% block title %}Upload File - Credential Manager{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4">
    <div>
        <h1 class="h2 mb-1">Upload</h1>
        <p class="text-muted mb-0">Upload files or queue downloads from direct links.</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-file-upload me-2"></i>Upload Credentials File</h5>
            </div>
            <div class="card-body">
                <!-- Upload Type Selector -->
                <ul class="nav nav-tabs mb-3" id="uploadTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-upload" type="button" role="tab">
                            <i class="fas fa-file me-1"></i>Upload File
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-download" type="button" role="tab">
                            <i class="fas fa-link me-1"></i>Download from URL
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="multi-url-tab" data-bs-toggle="tab" data-bs-target="#multi-url-download" type="button" role="tab">
                            <i class="fas fa-link me-1"></i>Multiple URLs
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="uploadTabContent">
                    <!-- File Upload Tab -->
                    <div class="tab-pane fade show active" id="file-upload" role="tabpanel">
                        <form method="POST" enctype="multipart/form-data" id="uploadForm">
                            <input type="hidden" name="upload_type" value="file">
                            <div class="mb-3">
                                <label for="file" class="form-label">Choose a text file to upload</label>
                                <input type="file" class="form-control" id="file" name="file" accept=".txt" required>
                                <div class="form-text">Only text files (.txt) up to 80 GB. Files auto-delete after 24 hours.</div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="uploadBtn">
                                <i class="fas fa-upload me-1"></i>Upload File
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                        </form>
                        <div class="mt-4" id="uploadProgressCard" style="display:none;">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="section-title"><i class="fas fa-cloud-upload-alt text-muted"></i> Upload Progress</div>
                                        <span class="status-pill status-processing" id="uploadStatus">Uploading</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 14px;">
                                        <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                                    </div>
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span id="uploadProgressText">0%</span>
                                        <span id="uploadSpeed">0 MB/s</span>
                                    </div>
                                    <div class="mt-3 code-block small" id="uploadLog"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- URL Download Tab -->
                    <div class="tab-pane fade" id="url-download" role="tabpanel">
                        <form method="POST" id="urlDownloadForm">
                            <input type="hidden" name="upload_type" value="url">
                            <div class="mb-3">
                                <label for="download_url" class="form-label">Paste Download URL</label>
                                <input type="url" class="form-control" id="download_url" name="download_url"
                                       placeholder="https://example.com/file.txt" required>
                                <div class="form-text">Paste the direct download link to the file. Files auto-delete after 24 hours.</div>
                            </div>
                            <button type="submit" class="btn btn-success" id="downloadBtn">
                                <i class="fas fa-download me-1"></i>Start Download
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                        </form>
                    </div>

                    <!-- Multiple URL Download Tab -->
                    <div class="tab-pane fade" id="multi-url-download" role="tabpanel">
                        <form method="POST" id="multiUrlDownloadForm">
                            <input type="hidden" name="upload_type" value="multi_url">
                            <div class="mb-3">
                                <label for="urls_text" class="form-label">Paste Multiple Download URLs</label>
                                <textarea class="form-control" id="urls_text" name="urls_text" rows="10"
                                          placeholder="https://clck.ru/3QSC88
https://clck.ru/3QSC88
https://clck.ru/3QSC88" required></textarea>
                                <div class="form-text">Enter one URL per line (or paste separated by spaces/commas). Maximum 50 URLs. Files auto-delete after 24 hours.</div>
                            </div>
                            <button type="submit" class="btn btn-success" id="multiDownloadBtn">
                                <i class="fas fa-download me-1"></i>Start Multiple Downloads
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>Upload Instructions</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li>Upload credential files in text format or download from URL</li>
                    <li>Files will be stored securely in your account</li>
                    <li>You can search through your uploaded files after uploading</li>
                    <li><strong>Max upload size:</strong> 80 GB per file</li>
                    <li><strong>Auto-deletion:</strong> All files automatically delete after 24 hours</li>
                    <li>Supports various combo formats including decorated headers</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const uploadForm = document.getElementById('uploadForm');
if (uploadForm) {
    uploadForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const progressCard = document.getElementById('uploadProgressCard');
        const progressBar = document.getElementById('uploadProgressBar');
        const progressText = document.getElementById('uploadProgressText');
        const speedText = document.getElementById('uploadSpeed');
        const statusPill = document.getElementById('uploadStatus');
        const logBox = document.getElementById('uploadLog');
        const startTime = Date.now();

        progressCard.style.display = 'block';
        statusPill.textContent = 'Uploading';
        statusPill.className = 'status-pill status-processing';
        logBox.textContent = 'Upload started...';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', uploadForm.action);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.upload.onprogress = function(evt) {
            if (!evt.lengthComputable) return;
            const percent = Math.round((evt.loaded / evt.total) * 100);
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';
            const elapsed = (Date.now() - startTime) / 1000;
            const speed = evt.loaded / Math.max(elapsed, 0.01);
            speedText.textContent = (speed / (1024 * 1024)).toFixed(2) + ' MB/s';
        };

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                const data = JSON.parse(xhr.responseText || '{}');
                statusPill.textContent = 'Completed';
                statusPill.className = 'status-pill status-completed';
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                logBox.textContent = data.message || 'Upload completed.';
                if (data.redirect) {
                    setTimeout(() => { window.location.href = data.redirect; }, 1200);
                }
            } else {
                let message = 'Upload failed. Please try again.';
                try {
                    const data = JSON.parse(xhr.responseText || '{}');
                    if (data.message) message = data.message;
                } catch (e) {}
                statusPill.textContent = 'Error';
                statusPill.className = 'status-pill status-error';
                logBox.textContent = message;
            }
        };

        xhr.onerror = function() {
            statusPill.textContent = 'Error';
            statusPill.className = 'status-pill status-error';
            logBox.textContent = 'Network error during upload.';
        };

        xhr.send(new FormData(uploadForm));
    });
}
</script>
{% endblock %}
